<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Категорії</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<div id="wrapper">
    <header>
        <ul id="navbar">
            <li><a href="/">Головна</a></li>
            <li><a href="#">Новини</a></li>
            <li><a href="">Послуги</a>
                <ul>
                    <li><a href="/all-products">Всі послуги</a></li>
                    <ul id="sections">
                        <!--                            <li><a href="#">Перукарські послуги</a></li>-->
                        <!--                            <li><a href="#">Візаж</a></li>-->
                        <!--                            <li><a href="#">Манікюр</a></li>-->
                    </ul>
                </ul>
            </li>
            <li><a href="#">Про нас</a></li>
            <li><a href="/admin">Адміністратор</a></li>
            <li><a href="/login">Увійти</a></li>
        </ul>
    </header>

    <aside>
    </aside>

    <main>
        <div class="menu">
            <a href="/create-product"><button class="menu-button" id="openCreateProduct">Керувати послугами</button></a>
            <a href="/create-category"><button class="menu-button" id="openCreateCategory">Керувати категоріями</button></a>
        </div>
        <div>
            <form>
                <label for="nameCategory">Назва категорії </label>
                <input type="text" id="nameCategory" name="name" placeholder="Name..">
                <select id="sectionsId">

                </select>
                <label for="getFileCategory">Додати зображення</label>
                <input type="file" id="getFileCategory">
                <input type="button" id="buttonCreateCategory" value="Створити категорію">
            </form>
        </div>

        <table id="categoriesAll">
            <thead>
            <tr>
                <th>id категорії</th>
                <th>Назва категорії</th>
                <th>Розділ</th>
                <th>Зображення</th>
                <th>Кнопка для видалення</th>
                <th>Кнопка для оновлення</th>
            </tr>
            </thead>
            <tbody id="allElements"></tbody>
        </table>

        <!-- The Modal update-->
        <div id="modalUpdate" class="modal">

            <!-- Modal content -->
            <div class="modal-content">
                <div class="modal-header">
                    <span id="closeModalUpdate" class="close">&times;</span>
                    <h2>Оновити категорію</h2>
                </div>
                <div class="modal-body">
                    <div>
                        <form>
                            <label for="categoryId">id категорії</label><br>
                            <input type="text" id="categoryId" name="categoryId" placeholder="Name.." value="0" readonly><br>
                            <label for="nameUpdate">Назва категорії</label><br>
                            <input type="text" id="nameUpdate" name="name" placeholder="Name.."><br>
                            <label for="sectionsIdUpdate">Розділ</label><br>
                            <select id="sectionsIdUpdate">

                            </select><br>
                            <label for="getFileUpdate">Додати зображення</label>
                            <input type="file" id="getFileUpdate">
                            <input type="button" id="btnUpdateButton" value="Оновити">
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <h3>Форма для оновлення категорії</h3>
                </div>
            </div>

        </div>

        <!-- The Modal Img-->
        <div id="imgModal" class="modal">

            <!-- Modal content -->
            <div class="modal-content">
                <div class="modal-header">
                    <span id="closeImgModal" class="close">&times;</span>
                    <h2>Перегляд зображення</h2>
                </div>
                <div class="modal-body">
                    <div id="img-container">

                        <!--<img src="http://localhost:8080/img/Весільна зачіска.jpeg" alt="no img">-->
                        <img src="" alt="">
                    </div>
                    <div id="img-switch">

                    </div>
                </div>
                <div class="modal-footer">
                    <h3>Форма для перегляду зображення</h3>
                </div>
            </div>
        </div>
    </main>

    <footer>
    </footer>
</div>

    <!--<script src="script.js"></script>-->
    <script>
        let mainUrl = "http://localhost:8080";
        // let mainUrl = "http://localhost:8000";

        getAllCreatedCategories();
        setModalImgConfiguration();
        setModalUpdateConfiguration();
        setActionOnCreateCategoryBtn();
        setActionOnUpdateButton();
        makeRequestSection();

        // start when load page PS reload page for triggered http request
        function getAllCreatedCategories() {
            $.ajax({
                url: mainUrl + "/category/page?direction=ASC&fieldName=sectionName&page=0&size=100",
                type: "GET",
                contentType: "application/json",
                success: function (dataResponse) {
                    setCreatedCategoriesToTable(dataResponse.data);
                    setActionOnDeleteButtonsCategory();
                    setActionOnImgCategoriesButtons();
                    setActionOnUpdateCategoryButtons();
                },
                error: function (error) {
                    console.log(error.message);
                }
            });
        }

        function setCreatedCategoriesToTable(categories) {
            for (var i = 0; i < categories.length; i++) {
                setCreatedCategoryToTable(categories[i]);
            }
        }

        function setCreatedCategoryToTable(category) {
            var tableOfCategories = $("#allElements");
            tableOfCategories.append('<tr>' +
                '<td>' + category.id + '</td>' +
                '<td>' + category.name + '</td>' +
                '<td>' + category.sectionName + '</td>' +
                '<td>' +
                    // '<a href="' + mainUrl + '/img/' + category.pathToImage + '" target="_blank">' +
                        '<button class="img-button" value="' + category.id + '">' +
                        'Переглянути зображення' +
                        '</button>' +
                    // '</a>' +
                '</td>' +
                '<td><button class="button" id="buttonDeleteCategory" value="' + category.id + '">Видалити</button></td>' +
                '<td><button class="buttonUpdate" value="' + category.id + '">Оновити</button></td>' +
                '</tr>');
        }

        //delete process
        function setActionOnDeleteButtonsCategory() {
            $(".button").each(function (index) {
                $(this).click(function () {
                    $.ajax({
                        url: mainUrl + "/category?id=" + $(this).val(),
                        type: "DELETE",
                        success: function (data) {
                            location.reload();
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                })
            })

        }

        function setActionOnCreateCategoryBtn() {
            $("#buttonCreateCategory").click(function(){
                let file = document.getElementById("getFileCategory").files[0];
                getBase64(file).then(data => {

                    let category = {
                        "fileRequest": {
                            "fileName": $("#nameCategory").val(),
                            "data": data
                        },
                        "name": $("#nameCategory").val(),
                        "sectionId": $("#sectionId").val()
                    };

                    $.ajax({
                        url: mainUrl + "/category",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(category),
                        success: function (data) {
                            console.log(data);
                            location.reload();
                        },
                        error: function (error) {
                            alert(error);
                            console.log(error);
                        }
                    });
                });
            });
        }

        //update process
        function setActionOnUpdateButton() {
            $("#btnUpdateButton").click(function(){
                let file = document.getElementById("getFileUpdate").files[0];
                getBase64(file).then(data => {

                    let category = {
                        "categoryId": $("#categoryId").val(),
                        "sectionId": $("#sectionsIdUpdate").val(),
                        "fileRequest": {
                            "fileName": $("#nameUpdate").val(),
                            "data": data
                        },
                        "name": $("#nameUpdate").val()
                    };

                    $.ajax({
                        url: mainUrl + "/category?id=" + $("#categoryId").val(),
                        type: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(category),
                        success: function (data) {
                            console.log(data);
                            location.reload();
                            alert("Категорію оновлено");
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                });
            });
        }


        function getCategoryById(id) {
            // let newCategory = {};
            $.ajax({
                url: mainUrl + "/category/findById?id=" + id,
                type: "GET",
                contentType: "application/json",
                success: function (category) {
                    // newCategory = category;
                    $("#nameUpdate").val(category.name);
                    $('#sectionsIdUpdate option[name="'+ category.sectionName + '"]').prop('selected', true);
                },
                error: function (error) {
                    console.log(error);
                }
            });
            // return newCategory;
        }

        // function setInputValueForUpdateCategory(category) {
        //     $("#nameUpdate").val(category.name);
        // }

        function setActionOnUpdateCategoryButtons() {
            $(".buttonUpdate").each(function (index) {
                $(this).click(function () {
                    $('#categoryId').val($(this).val());
                    // дописати функцію яка повертає один продукт за id, щоб можна було відразу підставити при кліку в інпути старі значення
                    // setInputValueForUpdateCategory(getCategoryById($(this).val()));
                    getCategoryById($(this).val());
                    document.getElementById('modalUpdate').style.display = "block";
                })
            })
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function setActionOnImgCategoriesButtons() {
            $(".img-button").each(function (index) {
                $(this).click(function () {
                    getImgCategory($(this).val());
                })
            })
        }

        function getImgCategory(id) {
            $('#img-container').html('');
            $.ajax({
                url: mainUrl + "/category/findById?id=" + id,
                type: "GET",
                contentType: "application/json",
                success: function (category) {
                    $('#img-container').append('<img class="category-image" src="' + mainUrl + '/img/' + category.pathToImage + '">')
                    document.getElementById('imgModal').style.display = "block";
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function setModalImgConfiguration() {
            // Get the modal
            var modal = document.getElementById('imgModal');

            // Get the <span> element that closes the modal
            var span = document.getElementById('closeImgModal');

            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                modal.style.display = "none";
            };

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        }

        //конфіг для модального вікна оновлення
        function setModalUpdateConfiguration() {
            // Get the modal
            var modal = document.getElementById('modalUpdate');

            // Get the <span> element that closes the modal
            var span = document.getElementById('closeModalUpdate');

            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                modal.style.display = "none";
            };

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        }

        function makeRequestSection() {
            $.ajax({
                url: mainUrl + "/section/page?direction=ASC&fieldName=name&page=0&size=100",
                type: 'GET',
                contentType: 'application/json',
                success: function (res) {
                    appendSectionsToMenu(res.data);
                    appendSectionsToContainer(res.data);
                    appendSectionsToContainerUpdate(res.data);
                },
                error: function (e) {
                    console.log(e)
                }
            })
        }
        //
        function appendSectionsToContainer(sections) {
            let $container = $('#sectionsId');
            $container.html('');
            for (let section of sections) {
                $container.append(`
                    <option value="${section.id}">${section.name}</option>
                `)
            }
        }

        function appendSectionsToContainerUpdate(sections) {
            let $container = $('#sectionsIdUpdate');
            $container.html('');
            for (let section of sections) {
                $container.append(`
                    <option name="${section.name}" value="${section.id}">${section.name}</option>
                `)
            }
        }

        function appendSectionsToMenu(sections) {
            let $container = $('#sections');
            $container.html('');
            for (let section of sections) {

                $container.append(`
                    <li><a onclick="makeRequestCategory(${section.id})">${section.name}</a></li>
                `)
            }
        }

    </script>
</body>
</html>

